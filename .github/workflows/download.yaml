name: EternalReturn Resource Downloader

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 16 * * *'  # æ¯å¤©UTCæ—¶é—´16:00è¿è¡Œï¼ˆå¯¹åº”åŒ—äº¬æ—¶é—´00:00ï¼‰
  push:
    branches: [ main, master ]

jobs:
  download-resources:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'none'
    - name: Run resource downloader JAR
      run: |
        java -jar ./EternalReturnDownloadResources.jar
        echo "âœ… Resource download process finished"
    - name: Calculate resource stats and stage files
      id: stats_and_stage
      run: |
        echo "ğŸ”„ Staging files and calculating stats..."
        git add -A
        
  
        if [ -d "./resources" ]; then
          PNG_COUNT=$(find ./resources -name "*.png" | wc -l)
          JSON_COUNT=$(find ./resources -name "*.json" | wc -l)
          TOTAL_COUNT=$(find ./resources -type f | wc -l)
        else
          PNG_COUNT=0
          JSON_COUNT=0
          TOTAL_COUNT=0
        fi
        
        echo "PNG_COUNT=$PNG_COUNT" >> $GITHUB_ENV
        echo "JSON_COUNT=$JSON_COUNT" >> $GITHUB_ENV
        echo "TOTAL_COUNT=$TOTAL_COUNT" >> $GITHUB_ENV
        echo "COMMIT_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
        
        echo "âœ… Stats calculated and files staged."

    
    - name: Commit and push downloaded resources (Optimized)
      id: auto_commit
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
    
        commit_message: |
          Auto-update: EternalReturn Resources ${{ env.COMMIT_DATE }}

          ğŸ“¦ Resource Summary:
          â€¢ Total Files: ${{ env.TOTAL_COUNT }}
          â€¢ PNG Images: ${{ env.PNG_COUNT }}
          â€¢ JSON Data: ${{ env.JSON_COUNT }}

          ğŸ® Content Types:
          - Character images & profiles
          - Weapon mastery icons  
          - Trait skills & groups
          - Item images
          - Tactical skills
          - Tier rankings

          ğŸ”„ Source: EternalReturn CDN (cdn.dak.gg)
          âš¡ Automated by: GitHub Actions CI/CD
          ğŸ“… Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          ğŸ”§ Workflow: ${{ github.workflow }}
          ğŸ†” Run ID: ${{ github.run_id }}
        commit_user_name: github-actions[bot]
        commit_user_email: github-actions[bot]@users.noreply.github.com
      
    - name: Workflow summary
      run: |
        echo "ğŸ‰ EternalReturn Resource Downloader Completed!"
        echo ""

        if [ "${{ steps.auto_commit.outputs.changes_detected }}" == "true" ]; then
          echo "âœ… æ–°èµ„æºå·²ä¸‹è½½ã€æš‚å­˜å¹¶æäº¤åˆ°ä»“åº“ã€‚"
          echo "ğŸ“ è¯·æ£€æŸ¥ 'resources' ç›®å½•ä»¥æŸ¥çœ‹æ›´æ–°æ–‡ä»¶ã€‚"
        else
          echo "â„¹ï¸ æœªæ£€æµ‹åˆ°æ–°èµ„æºä¸‹è½½â€”â€”æ‰€æœ‰æ–‡ä»¶éƒ½æ˜¯æœ€æ–°çš„ã€‚"
        fi
        echo ""
        echo "ğŸ”— Workflow URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
