name: EternalReturn Resource Downloader

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 8 * * *'  # æ¯å¤©UTCæ—¶é—´16:00è¿è¡Œï¼ˆå¯¹åº”åŒ—äº¬æ—¶é—´00:00ï¼‰
  push:
    branches: [ main, master ]

jobs:
  download-resources:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '23'
        distribution: 'temurin'
    - name: Run resource downloader JAR
      run: |
      
        java -version
        java -jar "EternalReturnDownloadResources.jar"
        echo "âœ… Resource download process finished"
        

    - name: Calculate resource stats and stage files
      id: stats_and_stage
      run: |
        echo "ğŸ”„ Staging files and calculating stats..."
       
        if [ -d "./resources/cache" ]; then
          echo "ğŸ—‘ï¸ Removing cache directory contents..."
          rm -rf ./resources/cache
        fi
        
        git add -A
  
        if [ -d "./resources" ]; then
          PNG_COUNT=$(find ./resources -name "*.png" | wc -l)
          JSON_COUNT=$(find ./resources -name "*.json" | wc -l)
          TOTAL_COUNT=$(find ./resources -type f | wc -l)
        else
          PNG_COUNT=0
          JSON_COUNT=0
          TOTAL_COUNT=0
        fi
        
        echo "PNG_COUNT=$PNG_COUNT" >> $GITHUB_ENV
        echo "JSON_COUNT=$JSON_COUNT" >> $GITHUB_ENV
        echo "TOTAL_COUNT=$TOTAL_COUNT" >> $GITHUB_ENV
        echo "COMMIT_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
        
        echo "âœ… Stats calculated and files staged."

    
    - name: Commit and push downloaded resources (Optimized)
      id: auto_commit
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
    
        commit_message: |
          Auto-update: EternalReturn Resources ${{ env.COMMIT_DATE }}

          Resource Summary:
          â€¢ Total Files: ${{ env.TOTAL_COUNT }}
          â€¢ PNG Images: ${{ env.PNG_COUNT }}
          â€¢ JSON Data: ${{ env.JSON_COUNT }}

          Content Types:
          - Character images & profiles
          - Weapon mastery icons  
          - Trait skills & groups
          - Item images
          - Tactical skills
          - Tier rankings

          ğŸ”„ Source: EternalReturn CDN (cdn.dak.gg)
          âš¡ Automated by: GitHub Actions CI/CD
          ğŸ“… Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          ğŸ”§ Workflow: ${{ github.workflow }}
          ğŸ†” Run ID: ${{ github.run_id }}
        commit_user_name: github-actions[bot]
        commit_user_email: github-actions[bot]@users.noreply.github.com
      

    - name: Compress resources
      if: steps.auto_commit.outputs.changes_detected == 'true' # åªæœ‰å½“æœ‰æ–°æ–‡ä»¶æäº¤æ—¶æ‰å‹ç¼©
      run: |
        echo "ğŸ“¦ Compressing resources directory..."
        zip -r eternal-return-resources.zip resources/
        echo "âœ… Compression complete."

    - name: Create GitHub Release
      if: steps.auto_commit.outputs.changes_detected == 'true'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: resources-${{ env.COMMIT_DATE }} 
        name: ğŸ“¦ Eternal Return Resources ${{ env.COMMIT_DATE }}
        files: eternal-return-resources.zip
        body: |
          ## ğŸ® Resource Auto-Update (${{ env.COMMIT_DATE }})
          
          èµ„æºåŒ…å·²è‡ªåŠ¨æ›´æ–°ã€‚
          
          ### ğŸ“Š ç»Ÿè®¡ä¿¡æ¯
          - **Total Files:** ${{ env.TOTAL_COUNT }}
          - **PNG Images:** ${{ env.PNG_COUNT }}
          - **JSON Files:** ${{ env.JSON_COUNT }}
          
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Workflow summary
      if: always() 
      run: |
        echo "completed!"
        echo "ğŸ”— Workflow URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
