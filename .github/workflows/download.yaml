name: EternalReturn Resource Downloader

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 16 * * *'  # æ¯å¤©UTCæ—¶é—´16:00è¿è¡Œï¼ˆå¯¹åº”åŒ—äº¬æ—¶é—´00:00ï¼‰
  push:
    branches: [ main, master ]

jobs:
  download-resources:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Find and verify JAR file
      id: find_jar
      run: |
        echo "ğŸ” Searching for JAR files..."
        # æŸ¥æ‰¾é .git ç›®å½•ä¸‹çš„æ‰€æœ‰ jar æ–‡ä»¶ï¼Œå¹¶å–ç¬¬ä¸€ä¸ª
        JAR_FILES=$(find . -name "*.jar" -type f ! -path "./.git/*" | head -5)
        if [ -z "$JAR_FILES" ]; then
          echo "âŒ No JAR files found in repository"
          exit 1
        fi
        
        echo "âœ… Found JAR files:"
        echo "$JAR_FILES"
        
        # é€‰æ‹©ç¬¬ä¸€ä¸ªJARæ–‡ä»¶
        MAIN_JAR=$(echo "$JAR_FILES" | head -1)
        echo "main_jar=$MAIN_JAR" >> $GITHUB_OUTPUT
        echo "ğŸ“¦ Using JAR: $MAIN_JAR"

    - name: Run resource downloader JAR
      run: |
        echo "ğŸš€ Starting EternalReturn resource download..."
        echo "JAR Path: ${{ steps.find_jar.outputs.main_jar }}"
        
        # è¿è¡ŒJARç¨‹åº
        java -jar "${{ steps.find_jar.outputs.main_jar }}" || echo "âš ï¸ JAR execution completed"
        
        echo "âœ… Resource download process finished"

    - name: Show downloaded resources summary
      id: show_summary
      run: |
        echo "ğŸ“Š Downloaded resources summary:"
        
        # æ£€æŸ¥resourcesç›®å½•
        if [ -d "./resources" ]; then
          echo "=== Resources Directory Structure ==="
          # æ˜¾ç¤ºå‰50ä¸ªæ–‡ä»¶
          find ./resources -type f | head -50 | while read file; do
            size=$(stat -c%s "$file" 2>/dev/null || echo "unknown")
            echo "ğŸ“„ $file ($(numfmt --to=iec $size 2>/dev/null || echo 'unknown size'))"
          done
          
          echo ""
          echo "=== File Count by Type ==="
          echo "ğŸ“ˆ PNG images: $(find ./resources -name "*.png" | wc -l)"
          echo "ğŸ“Š JSON files: $(find ./resources -name "*.json" | wc -l)"
          echo "ğŸ“ Total files: $(find ./resources -type f | wc -l)"
        else
          echo "âŒ Resources directory not found"
        fi
        
        echo ""
        echo "=== Git Status ==="
        git status --short

    # âœ¨ ä¼˜åŒ–ç‚¹ 1: ç‹¬ç«‹è¿›è¡Œ Git æš‚å­˜å’Œèµ„æºç»Ÿè®¡ï¼Œå°†æ•°æ®å†™å…¥ç¯å¢ƒå˜é‡ (ENV)
    - name: Calculate resource stats and stage files
      id: stats_and_stage
      run: |
        echo "ğŸ”„ Staging files and calculating stats..."
        
        # æš‚å­˜æ‰€æœ‰æ–‡ä»¶ï¼ˆåŒ…æ‹¬æ–°ä¸‹è½½çš„ resources ç›®å½•ï¼‰
        git add -A
        
        # è®¡ç®—èµ„æºç»Ÿè®¡æ•°æ®
        if [ -d "./resources" ]; then
          PNG_COUNT=$(find ./resources -name "*.png" | wc -l)
          JSON_COUNT=$(find ./resources -name "*.json" | wc -l)
          TOTAL_COUNT=$(find ./resources -type f | wc -l)
        else
          PNG_COUNT=0
          JSON_COUNT=0
          TOTAL_COUNT=0
        fi
        
        # å°†æ•°æ®å†™å…¥ $GITHUB_ENV ä¾›åç»­æ­¥éª¤ä½¿ç”¨
        echo "PNG_COUNT=$PNG_COUNT" >> $GITHUB_ENV
        echo "JSON_COUNT=$JSON_COUNT" >> $GITHUB_ENV
        echo "TOTAL_COUNT=$TOTAL_COUNT" >> $GITHUB_ENV
        echo "COMMIT_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
        
        echo "âœ… Stats calculated and files staged."

    # ç§»é™¤åŸæœ‰çš„ Configure Git for auto-commit æ­¥éª¤

    # âœ¨ ä¼˜åŒ–ç‚¹ 2: ä½¿ç”¨ git-auto-commit-action æ›¿æ¢å¤æ‚çš„è„šæœ¬
    - name: Commit and push downloaded resources (Optimized)
      id: auto_commit
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        # ä½¿ç”¨ä¸Šä¸€æ­¥è®¾ç½®çš„ç¯å¢ƒå˜é‡æ¥ç”Ÿæˆè¯¦ç»†çš„æäº¤ä¿¡æ¯
        commit_message: |
          Auto-update: EternalReturn Resources ${{ env.COMMIT_DATE }}

          ğŸ“¦ Resource Summary:
          â€¢ Total Files: ${{ env.TOTAL_COUNT }}
          â€¢ PNG Images: ${{ env.PNG_COUNT }}
          â€¢ JSON Data: ${{ env.JSON_COUNT }}

          ğŸ® Content Types:
          - Character images & profiles
          - Weapon mastery icons  
          - Trait skills & groups
          - Item images
          - Tactical skills
          - Tier rankings

          ğŸ”„ Source: EternalReturn CDN (cdn.dak.gg)
          âš¡ Automated by: GitHub Actions CI/CD
          ğŸ“… Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          ğŸ”§ Workflow: ${{ github.workflow }}
          ğŸ†” Run ID: ${{ github.run_id }}
        commit_user_name: github-actions[bot]
        commit_user_email: github-actions[bot]@users.noreply.github.com
        # è¯¥ Action ä¼šè‡ªåŠ¨æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–ï¼Œæ²¡æœ‰å˜åŒ–åˆ™è·³è¿‡æäº¤å’Œæ¨é€

    # âœ¨ ä¼˜åŒ–ç‚¹ 3: æ›´æ–° Workflow summary ä¾èµ– auto_commit çš„è¾“å‡º
    - name: Workflow summary
      run: |
        echo "ğŸ‰ EternalReturn Resource Downloader Completed!"
        echo ""
        # æ£€æŸ¥ auto_commit Action çš„è¾“å‡ºï¼Œåˆ¤æ–­æ˜¯å¦å‘ç”Ÿäº†æäº¤
        if [ "${{ steps.auto_commit.outputs.changes_detected }}" == "true" ]; then
          echo "âœ… æ–°èµ„æºå·²ä¸‹è½½ã€æš‚å­˜å¹¶æäº¤åˆ°ä»“åº“ã€‚"
          echo "ğŸ“ è¯·æ£€æŸ¥ 'resources' ç›®å½•ä»¥æŸ¥çœ‹æ›´æ–°æ–‡ä»¶ã€‚"
        else
          echo "â„¹ï¸ æœªæ£€æµ‹åˆ°æ–°èµ„æºä¸‹è½½â€”â€”æ‰€æœ‰æ–‡ä»¶éƒ½æ˜¯æœ€æ–°çš„ã€‚"
        fi
        echo ""
        echo "ğŸ”— Workflow URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
